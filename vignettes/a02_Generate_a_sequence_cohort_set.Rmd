---
title: "Step 1. Generate a sequence cohort"
output:
    html_document:
    pandoc_args: [
      "--number-offset=1,0"
      ]
    number_sections: yes
    toc: yes
vignette: >
  %\VignetteIndexEntry{a02_Generate_a_sequence_cohort}
  %\VignetteEngine{knitr::rmarkdown}
  %\VignetteEncoding{UTF-8}
---

```{r, include = FALSE}
knitr::opts_chunk$set(
  collapse = TRUE,
  comment = "#>",
  fig.width = 7,
  fig.height = 5,
  eval = Sys.getenv("$RUNNER_OS") != "macOS"
)
```



# Introduction
In this vignette we will explore the functionalities of `generateSequenceCohort()`. 

## Create a cdm object
CohortSymmetry package is designed to work with data mapped to OMOP, so the first step is to create a reference to the data using the CDMConnector package. We will use the Eunomia dataset for the subsequent examples. 

```{r message= FALSE, warning=FALSE}
library(CDMConnector)
library(dplyr)
library(DBI)
library(omock)
library(CohortSymmetry)
library(duckdb)
library(here)

con <- DBI::dbConnect(duckdb::duckdb(), CDMConnector::eunomia_dir())

cdm <- CDMConnector::cdm_from_con(
  con = con,
  cdm_schema = "main",
  write_schema = "main"
)
```

## Instantiate two cohorts in the cdm reference
CohortSymmetry package requires that the cdm object contains two cohorts tables: one for the index cohort and the other one for the marker cohort. There are a lot of different ways to create these cohorts, and it will depend on what the index cohort and marker cohort represent. Here, we use the DrugUtilisation package to generate two drug cohorts in the cdm object. For illustrative purposes, we will carry out PSSA on aspirin (index_cohort) against acetaminophen (marker_cohort).

```{r message= FALSE, warning=FALSE}
library(DrugUtilisation)
cdm <- DrugUtilisation::generateIngredientCohortSet(
  cdm = cdm,
  name = "aspirin",
  ingredient = "aspirin")

cdm <- DrugUtilisation::generateIngredientCohortSet(
  cdm = cdm,
  name = "acetaminophen",
  ingredient = "acetaminophen")
```

# Generate a sequence cohort
In order to initiate the calculations, the two cohorts tables need to be intersected using `generateSequenceCohortSet()`. This process will output all the individuals who appeared on both tables according to user-specified parameters. Let's go through a few examples to see how this function works.

## No specific requirements
Let's study the simplest case, where no study period, prior history, washout window, or time gap between the index and the marker, are specified. See figure below to see an example of a dataset containing five different participants.

```{r,echo=FALSE, message=FALSE, out.width="80%", warning=FALSE}
knitr::include_graphics(here("vignettes/figures/1-NoRestrictions.png"))
```

See that only the first event or episode (either for the index and the marker) is included in the analysis. As there is no restriction criteria and all the individuals have an episode of the index and the marker cohort, all the subjects are included in the database. We can get a sequence cohort without including any particular requirement like so:

```{r message= FALSE, warning=FALSE}
cdm <- generateSequenceCohortSet(
  cdm = cdm,
  indexTable = "aspirin",
  markerTable = "acetaminophen",
  name = "intercept",
  combinationWindow = c(0, Inf))

cdm$intercept 
```
See that the generated table has the format of an OMOP CDM cohort, but it also includes two additional columns: the *index_date* and the *marker_date*, which are the dates of the index and marker event, respectively. The *cohort_start_date* and the *cohort_end_date* are defined as:
-   **cohort_start_date**: earliest date between `ìndex_date` and `marker_date`.
-   **cohort_end_date**: latest date between `ìndex_date` and `marker_date`.

## Specified study period
We can also specify the study period of the analysis. Hence, the observation period will be restricted to these dates and only events or episodes happening during these period will be accounted for the analysis, as represented in the below figure:

```{r,echo=FALSE, message=FALSE, out.width="80%", warning=FALSE}
knitr::include_graphics(here("vignettes/figures/2-studyPeriod.png"))
```

Notice that, by imposing a restriction on study period, some of the participants might be excluded. The study period can be restricted using the `cohortDateRange` argument, which is defined as:
<center>
cohortDateRange = c(start_of_the_study_period, end_of_the_study_period)
<center>
```{r message= FALSE, warning=FALSE}
cdm <- generateSequenceCohortSet(
  cdm = cdm,
  indexTable = "aspirin",
  markerTable = "acetaminophen",
  name = "intercept",
  cohortDateRange = as.Date(c("1950-01-01","1969-01-01")),
  combinationWindow = c(0, Inf))

cdm$intercept |> 
  summarise(min_cohort_start_date = min(cohort_start_date), 
            max_cohort_start_date = max(cohort_start_date),
            min_cohort_end_date   = min(cohort_end_date),
            max_cohort_end_date   = max(cohort_end_date))
```
See that *cohort_start_date* and *cohort_end_date* range fall into the pre-specified period.

## Specified study period and prior history requirement
If we also add some requirement of prior history then somebody will only contribute time at risk once this is reached.

```{r,echo=FALSE, message=FALSE, out.width="80%", warning=FALSE}
knitr::include_graphics(here("vignettes/figures/3-PriorObservation.png"))
```

We can use the argument `daysPriorObservation` to specify how many days of prior observation are required. See an example below:

```{r message= FALSE, warning=FALSE}
cdm$intercept |> 
  inner_join(
    cdm$observation_period |> 
      select("subject_id" = "person_id", "observation_period_start_date")
  ) |>
  filter(subject_id %in% c(2,53))

cdm <- generateSequenceCohortSet(
  cdm = cdm,
  indexTable = "aspirin",
  markerTable = "acetaminophen",
  name = "intercept",
  cohortDateRange = as.Date(c("1950-01-01","1980-01-01")),
  daysPriorObservation = 365,
  combinationWindow = c(0, Inf))

cdm$intercept |> 
  inner_join(
    cdm$observation_period |> 
      select("subject_id" = "person_id", "observation_period_start_date")
  ) |>
  filter(subject_id %in% c(2,53))
```
As `subject_id = 53` did not fulfilled the prior history requirement, it has been excluded from the analysis.

## Specified study period, prior history requirement and washout period
We can also specify the minimum washout period required for an event or episode to be included. In the following figure, we exclude participant number 6 as another episode happened within the washout period:
```{r,echo=FALSE, message=FALSE, out.width="80%", warning=FALSE}
knitr::include_graphics(here("vignettes/figures/4-washoutPeriod.png"))
```

This functionality can be implemented using the `washoutWindow`argument:
```{r message= FALSE, warning=FALSE}
cdm <- generateSequenceCohortSet(
  cdm = cdm,
  indexTable = "aspirin",
  markerTable = "acetaminophen",
  name = "intercept",
  cohortDateRange = as.Date(c("1950-01-01","1969-01-01")),
  daysPriorObservation = 365,
  washoutWindow = 90,
  combinationWindow = c(0, Inf))

cdm$intercept |>
  filter(subject_id %in% c(163, 1000))
```

## Specified study period, prior history requirement and combination window
We define the combination window as the minimum and the maximum days between the start of the first event (either if is the index or the marker) and the start of the next event. In other words: 
<center>
x = second_episode(start_date) - first_episode(start_date) 
combinationWindow[1] $\leq$ x $\leq$ combinationWindow[2] 
combinationWindow[1] $<$ x $\leq$ combinationWindow[2] 
<center>

It can also be seen as a restriction between the *cohort_end_date* and the *cohort_start_date* of the **intercept** cohort. See in the figure below an example, where we define `combinationWindow = c(0,20)`. This means that the gap between the start date of the second episode and the start of the first episode should be larger than 0 and less or equal than 20:
```{r,echo=FALSE, message=FALSE, out.width="80%", warning=FALSE}
knitr::include_graphics(here("vignettes/figures/5-combinationWindow_numbers.png"))
```
In the function, this is implemented using the `combinationWindow` argument. See the example below where we use a combination window of `combinationWindow = c(0, 90)`:
```{r message= FALSE, warning=FALSE}
# M'HE QUEDAT AQUIIII

cdm <- generateSequenceCohortSet(
  cdm = cdm,
  indexTable = "aspirin",
  markerTable = "acetaminophen",
  name = "intercept",
  cohortDateRange = as.Date(c("1950-01-01","1969-01-01")),
  daysPriorObservation = 365,
  combinationWindow = c(0, 90))
```
## Specified study period, prior history requirement and index gap
We also define the index-marker gap to specify the maximum number of days between the start of the second episode (either if is the index or the marker) and the end of the first episode. That means:
<center>
x = second_episode(cohort_start_date) - first_episode(cohort_end_date)
x <= indexMarkerGap
<center>

Use `indexGap` in the function:
```{r message= FALSE, warning=FALSE}
cdm <- generateSequenceCohortSet(
  cdm = cdm,
  indexTable = "aspirin",
  markerTable = "acetaminophen",
  name = "intercept",
  cohortDateRange = as.Date(c("1950-01-01","1969-01-01")),
  daysPriorObservation = 365,
  indexMarkerGap = 31)

cdm$intercept 
```
